<!DOCTYPE html>
<style>
  html { font-size: 12px; font-family: -apple-system, BlinkMacSystemFont; }
  html, body { height: 100%; margin: 0; padding: 0; }
  body { display: flex; flex-direction: column; }

  button { cursor: pointer }
  button:active { opacity: .7; }
  button[disabled] { opacity: .5; cursor: not-allowed; }
  button, input { border: none; border-radius: 3px; padding: 4px 7px; }

  * { color: black; }
  input, textarea, button { background: white; }
  @media (prefers-color-scheme: dark) {
    * { color: white; }
    input, textarea, button { background: dimgray; }
  }
</style>

<header style="padding: 20px;">
  <h1 style="margin: 0; padding: 0; font-weight:200;">Configure your <b>Multi</b> app</h1>
</header>

<div style="padding: 20px; padding-top: 0; display: flex; flex-direction: row;">
  <input style="margin-right: 10px;" type="text" placeholder="App Name" id="name" autofocus>
  <button id="icon">Select Icon</button>
</div>

<textarea style="margin: 0; padding: 20px; flex: 1 0 auto; border: none; white-space: pre; font-family: 'SF Mono', monospace; resize: none;" placeholder='[{ "title": "Example Site", "url": "https://example.com" }]' spellcheck="false" id="json">[
  {
    "title": "Bare minimum example",
    "url": "https://example.com"
  },
  {
    "title": "Use \"isolated\" to separate cookies",
    "url": "https://example.com",
    "isolated": true
  },
  {
    "title": "Use \"blocklist\" to block ads and trackers",
    "url": "https://example.com",
    "blocklist": true
  }
]</textarea>

<footer style="padding: 20px; display: flex; flex-direction: row; justify-content: space-between;">
  <em id="error"></em>
  <button id="save">Save & Launch</button>
</footer>

<script>
  const state = {};
  const error = document.getElementById("error");
  const save = document.getElementById("save");
  save.addEventListener("click", submit);

  connect(name, document.getElementById("name"));
  connect(json, document.getElementById("json"));
  document.getElementById("icon").addEventListener("click", icon);

  function connect(validate, element) {
    const listener = () => {
      try { update(element.id, "", validate(element.value)) }
      catch (e) { update(element.id, e.message, { error: true }) }
    }
    listener();
    element.addEventListener("input", listener);
  }

  function update(id, message, data) {
    error.innerText = message;
    state[id] = data;
    save.disabled = Object.values(state).some(x => x.error);
  }

  function name(value) {
    if (value === "") throw new Error("Name cannot be empty")
    else return value;
  }

  function json(value) {
    const config = JSON.parse(value);
    if (!Array.isArray(config)) throw new Error("Expecting an ARRAY at the first level");
    if (!config.every(x => x.title)) throw new Error("Each site must include a \"title\" field");
    if (!config.every(x => x.url)) throw new Error("Each site must include a \"url\" field");
    return config;
  }

  function icon(event) {
    window.webkit.messageHandlers.icon.postMessage();
  }

  function submit(event) {
    window.webkit.messageHandlers.save.postMessage({
      // TODO
    });
  }
</script>
